<?php

namespace Brasa\RecursoHumanoBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class RhuPagoBancoRepository extends EntityRepository {

    public function listaDQL($strFechaDesde = "", $strFechaHasta = "", $codigoPagoBancoTipo = "", $estadoAutorizado = "", $estadoGenerado = "") {
        $dql = "SELECT pb FROM BrasaRecursoHumanoBundle:RhuPagoBanco pb WHERE pb.codigoPagoBancoPk <> 0";
        if ($strFechaDesde != "") {
            $dql .= " AND pb.fechaAplicacion >= '" . $strFechaDesde . "'";
        }
        if ($strFechaHasta != "") {
            $dql .= " AND pb.fechaAplicacion <= '" . $strFechaHasta . "'";
        }
        if ($codigoPagoBancoTipo != "") {
            $dql .= " AND pb.codigoPagoBancoTipoFk = " . $codigoPagoBancoTipo;
        }
        if ($estadoGenerado == 1) {
            $dql .= " AND pb.estadoGenerado = 1";
        }
        if ($estadoGenerado == '0') {
            $dql .= " AND pb.estadoGenerado = 0";
        }
        if ($estadoAutorizado == 1) {
            $dql .= " AND pb.estadoAutorizado = 1";
        }
        if ($estadoAutorizado == '0') {
            $dql .= " AND pb.estadoAutorizado = 0";
        }
        $dql .= " ORDER BY pb.codigoPagoBancoPk DESC";
        return $dql;
    }

    public function liquidar($codigoPagoBanco) {
        $em = $this->getEntityManager();
        $arPagoBanco = $em->getRepository('BrasaRecursoHumanoBundle:RhuPagoBanco')->find($codigoPagoBanco);
        $arPagoBancoDetalles = $em->getRepository('BrasaRecursoHumanoBundle:RhuPagoBancoDetalle')->findBy(array('codigoPagoBancoFk' => $codigoPagoBanco));
        $douTotal = 0;
        $intNumeroRegistros = 0;
        foreach ($arPagoBancoDetalles AS $arPagoBancoDetalle) {
            $douTotal += $arPagoBancoDetalle->getVrPago();
            $intNumeroRegistros++;
        }
        $arPagoBanco->setVrTotalPago($douTotal);
        $arPagoBanco->setNumeroRegistros($intNumeroRegistros);
        $em->persist($arPagoBanco);
        $em->flush();
    }

    public function pendientesContabilizarDql() {
        $dql = "SELECT pb FROM BrasaRecursoHumanoBundle:RhuPagoBanco pb WHERE pb.estadoContabilizado = 0 AND pb.estadoAutorizado = 1 AND pb.estadoGenerado = 1 ";
        $dql .= " ORDER BY pb.codigoPagoBancoPk DESC";
        return $dql;
    }

    public function contabilizadosPagoBancoDql($intPagoDesde = 0, $intPagoHasta = 0, $strDesde = "", $strHasta = "") {
        $em = $this->getEntityManager();
        $dql = "SELECT pb FROM BrasaRecursoHumanoBundle:RhuPagoBanco pb WHERE pb.estadoContabilizado = 1";
        if ($intPagoDesde != "" || $intPagoDesde != 0) {
            $dql .= " AND pb.numero >= " . $intPagoDesde;
        }
        if ($intPagoHasta != "" || $intPagoHasta != 0) {
            $dql .= " AND pb.numero <= " . $intPagoHasta;
        }
        if ($strDesde != "" || $strDesde != 0) {
            $dql .= " AND pb.fecha >='" . date_format($strDesde, ('Y-m-d')) . "'";
        }
        if ($strHasta != "" || $strHasta != 0) {
            $dql .= " AND pb.fecha <='" . date_format($strHasta, ('Y-m-d')) . "'";
        }

        $query = $em->createQuery($dql);
        $arrayResultado = $query->getResult();
        return $arrayResultado;
    }

    public function anular($codigoPagoBanco) {
        $strResultado = "";
        $em = $this->getEntityManager();
        $arPagoBanco = new \Brasa\RecursoHumanoBundle\Entity\RhuPagoBanco();
        $arPagoBanco = $em->getRepository('BrasaRecursoHumanoBundle:RhuPagoBanco')->find($codigoPagoBanco);
        if ($arPagoBanco->getEstadoAutorizado() == 1 && $arPagoBanco->getEstadoAnulado() == 0 && $arPagoBanco->getNumero() != 0 && $arPagoBanco->getEstadoContabilizado() == 0) {
            $arPagoBancoDetalles = new \Brasa\RecursoHumanoBundle\Entity\RhuPagoBancoDetalle();
            $arPagoBancoDetalles = $em->getRepository('BrasaRecursoHumanoBundle:RhuPagoBancoDetalle')->findBy(array('codigoPagoBancoFk' => $codigoPagoBanco));
            if ($arPagoBancoDetalles) {
                foreach ($arPagoBancoDetalles as $arPagoBancoDetalle) {
                    //Validar que el tipo de pago banco sea de tipo nomina
                    if ($arPagoBanco->getCodigoPagoBancoTipoFk() == 1) {
                        $arPago = new \Brasa\RecursoHumanoBundle\Entity\RhuPago();
                        $arPago->setEstadoPagadoBanco(0);
                        $arPago->setEstadoPagado(0);
                        $arPago = $em->getRepository('BrasaRecursoHumanoBundle:RhuPago')->find($arPagoBancoDetalle->getCodigoPagoFk());
                        $em->persist($arPago);
                    }
                    //Validar que el tipo de pago banco sea de tipo vacacion
                    if ($arPagoBanco->getCodigoPagoBancoTipoFk() == 2) {
                        $arVacacion = new \Brasa\RecursoHumanoBundle\Entity\RhuVacacion();
                        $arVacacion = $em->getRepository('BrasaRecursoHumanoBundle:RhuVacacion')->find($arPagoBancoDetalle->getCodigoVacacionFk());
                        $arVacacion->setEstadoPagoBanco(0);
                        $arVacacion->setEstadoPagoGenerado(0);
                        $em->persist($arVacacion);
                    }
                    //Validar que el tipo de pago banco sea de tipo liquidacion
                    if ($arPagoBanco->getCodigoPagoBancoTipoFk() == 3) {
                        $arLiquidacion = new \Brasa\RecursoHumanoBundle\Entity\RhuLiquidacion();
                        $arLiquidacion = $em->getRepository('BrasaRecursoHumanoBundle:RhuLiquidacion')->find($arPagoBancoDetalle->getCodigoLiquidacionFk());
                        $arLiquidacion->setEstadoPagoBanco(0);
                        $arLiquidacion->setEstadoPagoGenerado(0);
                        $em->persist($arLiquidacion);
                    }
                    //Validar que el tipo de pago banco sea de tipo seguridad social
                     if ($arPagoBanco->getCodigoPagoBancoTipoFk() == 4) {
                        $arSsoPeriodoDetalle = new \Brasa\RecursoHumanoBundle\Entity\RhuSsoPeriodoDetalle();
                        $arSsoPeriodoDetalle = $em->getRepository('BrasaRecursoHumanoBundle:RhuSsoPeriodoDetalle')->find($arPagoBancoDetalle->getCodigoPeriodoDetalleFk());
                        $arSsoPeriodoDetalle->setEstadoPagoBanco(0);
                        $em->persist($arSsoPeriodoDetalle);
                    }
                    
                    //Validar que el tipo de pago banco sea de tipo prima
                   if ($arPagoBanco->getCodigoPagoBancoTipoFk() == 5) {
                        $arPago = new \Brasa\RecursoHumanoBundle\Entity\RhuPago();
                        $arPago = $em->getRepository('BrasaRecursoHumanoBundle:RhuPago')->find($arPagoBancoDetalle->getCodigoPagoFk());
                        $arPago->setEstadoPagadoBanco(0);
                        $arPago->setEstadoPagado(0);
                        $em->persist($arPago);
                    }
                    //Validar que el tipo de pago banco sea de tipo cesantias e intereses
                    if ($arPagoBanco->getCodigoPagoBancoTipoFk() == 6) {
                        $arSsoAporte = new \Brasa\RecursoHumanoBundle\Entity\RhuSsoPeriodoDetalle();
                        $arSsoAporte = $em->getRepository('BrasaRecursoHumanoBundle:RhuSsoPeriodoDetalle')->find($arPagoBancoDetalle->getCodigoAporteFk());
                        $arSsoAporte->setEstadoPagoBanco(0);
                        $em->persist($arSsoAporte);
                    }
                    $arPagoBancoDetalle->setVrPago(0);
                    $em->persist($arPagoBancoDetalle);
                }
            }
            $arPagoBanco->setVrTotalPago(0);
            $arPagoBanco->setEstadoAnulado(1);
            $em->persist($arPagoBanco);
        } else {
            $strResultado = "El pago banco debe estar autorizada e impresa, no puede estar previamente anulada ni contabilizada";
        }
        $em->flush();
        return $strResultado;
    }

}
